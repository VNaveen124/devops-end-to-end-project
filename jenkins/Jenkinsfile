pipeline {
    agent any

    environment {
        AWS_ACCOUNT_ID = "YOUR_AWS_ACCOUNT_ID"
        AWS_REGION = "us-east-1"
        ECR_REGISTRY = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
        FRONTEND_IMAGE_NAME = "frontend"
        BACKEND_IMAGE_NAME = "backend"
        IMAGE_TAG = "build-${BUILD_NUMBER}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build & Unit Test Frontend') {
            steps {
                dir('frontend') {
                    sh 'npm install'
                    sh 'npm test'
                }
            }
        }

        stage('Build & Unit Test Backend') {
            steps {
                dir('backend') {
                    sh 'pip install -r requirements.txt'
                    sh 'pytest'
                }
            }
        }


        stage('Docker Build & Push Frontend') {
            steps {
                dir('frontend') {
                    script {
                            def img = docker.build("${FRONTEND_IMAGE_NAME}:${IMAGE_TAG}")
                            img.push()
                        }
                    }
                }
            }
        }

        stage('Docker Build & Push Backend') {
            steps {
                dir('backend') {
                    script {
                            def img = docker.build("${BACKEND_IMAGE_NAME}:${IMAGE_TAG}")
                            img.push()
                        }
                    }
                }
            }
        }

        stage('Security Scan Frontend') {
            steps {
                
            }
        }

        stage('Security Scan Backend') {
            steps {

            }
        }

        stage('Deploy Trigger to ArgoCD') {
            steps {
                script {
                    // This step would typically involve updating the image tag in the k8s manifests
                    // and pushing the change to the Git repository, which would trigger ArgoCD to sync.
                    // For this example, we'll just print a message.
                    echo "Triggering ArgoCD deployment..."
                    // Example:
                    // withCredentials([gitUsernamePassword(credentialsId: 'github-credentials', usernameVariable: 'GIT_USERNAME', passwordVariable: 'GIT_PASSWORD')]) {
                    //     sh 'git config --global user.email "jenkins@example.com"'
                    //     sh 'git config --global user.name "Jenkins"'
                    //     sh 'git checkout -b release'
                    //     sh "sed -i 's|image:.*|image: ${ECR_REGISTRY}/${FRONTEND_IMAGE_NAME}:${IMAGE_TAG}|g' k8s/overlays/dev/frontend-deployment.yaml"
                    //     sh "sed -i 's|image:.*|image: ${ECR_REGISTRY}/${BACKEND_IMAGE_NAME}:${IMAGE_TAG}|g' k8s/overlays/dev/backend-deployment.yaml"
                    //     sh 'git add k8s/overlays/dev'
                    //     sh 'git commit -m "Update image tags for build ${BUILD_NUMBER}"'
                    //     sh 'git push https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/your-repo.git release'
                    // }
                }
            }
        }
    }
}
